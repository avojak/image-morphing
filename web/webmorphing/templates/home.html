<!doctype html>
<head>
    <title>Image Morphing</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='album.css') }}">
</head>

<body>

    <main>
        <section class="jumbotron text-center">
            <div class="container">
                <h1 class="jumbotron-heading">Image Morphing</h1>
                <p class="lead text-muted">TODO Some summary</p>
            </div>
        </section>
        <form method="POST" id="images" action="{{ url_for('home.morph') }}" enctype="multipart/form-data">
            <div class="album py-5 bg-light">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="card box-shadow" id="source-img-card" style="margin: 20px;">
                            <div class="card-top">
                                <canvas id="source-img-canvas" style="cursor:crosshair; margin: 20px 20px 0 20px;"></canvas>
                            </div>
                            <div class="card-body">
                                <div class="input-group">
                                    <div class="custom-file" style="margin-bottom: 20px;">
                                        <input type="file" class="custom-file-input" id="source-img-input" name="source-img">
                                        <label class="custom-file-label" for="source-img-input">Choose source image</label>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary">Clear Points</button>
                                    </div>
                                    <small class="text-muted"><span id="source-point-count">0</span> points</small>
                                </div>
                            </div>
                        </div>
                        <div class="card box-shadow" style="margin: 20px;">
                            <div class="card-img-top">
                                <canvas id="target-img-canvas" style="cursor:crosshair; margin: 20px 20px 0 20px;"></canvas>
                            </div>
                            <div class="card-body">
                                <div class="input-group">
                                    <div class="custom-file" style="margin-bottom: 20px;">
                                        <input type="file" class="custom-file-input" id="target-img-input" name="target-img">
                                        <label class="custom-file-label" for="target-img-input">Choose target image</label>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary">Clear Points</button>
                                    </div>
                                    <small class="text-muted"><span id="target-point-count">0</span> points</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row justify-content-center">
                        <p>
                            <label for="gif_duration">GIF duration (between 1 and 5 seconds):</label>
                            <input type="number" id="gif_duration" name="gif_duration" min="1" max="5" value="3">
                        </p>
                        <p>
                            <label for="gif_fps">GIF FPS (between 1 and 10):</label>
                            <input type="number" id="gif_fps" name="gif_fps" min="1" max="10" value="10">
                        </p>
                        <p><button type="submit" form="images">Go!</button></p>
                    </div>
                </div>
            </div>
        </form>
    </main>

</body>

<section class="content">
    <header>
        {% block header %}{% endblock %}
    </header>
    {% for message in get_flashed_messages() %}
    <div class="flash">{{ message }}</div>
    {% endfor %}
    {% block content %}{% endblock %}
</section>

<script src="https://code.jquery.com/jquery-3.5.0.min.js"
        integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ="
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<script>
    /**
     * Listener function called by the when a 'change' event occurs on the image loaders.
     * @param e The event
     */
    function loadImage(e) {
        let reader = new FileReader();
        let canvas = document.getElementById(e.currentTarget.canvasElementId);
        reader.onload = function (event) {
            let img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
        // Reset the selected points when a new image is loaded
        e.currentTarget.selectedPoints = [];
    }

    let sourceImageLoader = document.getElementById('source-img-input');
    sourceImageLoader.addEventListener('change', loadImage, false);
    sourceImageLoader.canvasElementId = "source-img-canvas";
    sourceImageLoader.cardElementId = "source-img-card";
    sourceImageLoader.selectedPoints = [];

    let targetImageLoader = document.getElementById('target-img-input');
    targetImageLoader.addEventListener('change', loadImage, false);
    targetImageLoader.canvasElementId = "target-img-canvas";
    targetImageLoader.cardElementId = "target-img-card";
    targetImageLoader.selectedPoints = [];

    $('#source-img-input').change(function(e) {
        $(this).next('.custom-file-label').html(e.target.files[0].name);
    });

    $('#target-img-input').change(function(e) {
        $(this).next('.custom-file-label').html(e.target.files[0].name);
    });

    /**
     * Listener function call when a click event occurs on the canvas.
     * @param e The event
     * @param canvas The canvas
     * @param points The array of points which have been clicked on the canvas
     */
    function onPointClicked(e, canvas, points) {
        // Get the coordinates of the click on the canvas
        let rect = canvas.getBoundingClientRect();
        let x = e.clientX - rect.left;
        let y = e.clientY - rect.top;

        // Add the coordinates to our list of points
        points.push([x,y]);
        console.log(points);

        // Draw the coordinates on the canvas
        let pointSize = 3;
        let ctx = canvas.getContext('2d');
        ctx.fillStyle = 'red';
        ctx.font = 'bold 16px Arial';
        ctx.fillText(points.length, x+5, y); // +5 to add some space between the point and the number
        ctx.beginPath();
        ctx.arc(x, y, pointSize, 0, Math.PI * 2, true);
        ctx.fill();

        // TODO: Add some check as to whether there are equal numbers of points selected
    }

    $('#source-img-canvas').click(function(e) {
        onPointClicked(e, document.getElementById('source-img-canvas'), sourceImageLoader.selectedPoints);
        $('#source-point-count').html(sourceImageLoader.selectedPoints.length);
    });
    $('#target-img-canvas').click(function(e) {
        onPointClicked(e, document.getElementById('target-img-canvas'), targetImageLoader.selectedPoints);
        $('#target-point-count').html(targetImageLoader.selectedPoints.length);
    });

    $("#images").submit(function(e) {
       $("<input />").attr('type', 'hidden')
                     .attr('name', 'source_points')
                     .attr('value', JSON.stringify(sourceImageLoader.selectedPoints))
                     .appendTo('#images');
       $("<input />").attr('type', 'hidden')
                     .attr('name', 'target_points')
                     .attr('value', JSON.stringify(targetImageLoader.selectedPoints))
                     .appendTo('#images');
       return true;
    });
</script>